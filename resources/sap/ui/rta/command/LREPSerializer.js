/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/rta/command/FlexCommand","sap/ui/rta/command/AppDescriptorCommand","sap/ui/rta/ControlTreeModifier","sap/ui/rta/Utils","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Utils","sap/ui/fl/Change","sap/ui/fl/registry/Settings","sap/ui/dt/ElementUtil","sap/base/Log"],function(M,F,A,R,a,b,c,C,S,E,L){"use strict";var d=M.extend("sap.ui.rta.command.LREPSerializer",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.core.Control"}},properties:{commandStack:{type:"object"}},aggregations:{}}});function g(r){return E.getElementInstance(r);}d.prototype._lastPromise=Promise.resolve();d.prototype.setCommandStack=function(o){if(this.getCommandStack()){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted);}this.setProperty("commandStack",o);o.addCommandExecutionHandler(this._fnHandleCommandExecuted);};d.prototype.init=function(){this._fnHandleCommandExecuted=this.handleCommandExecuted.bind(this);};d.prototype.exit=function(){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted);};d.prototype._isPersistedChange=function(p){return!!this.getCommandStack()._aPersistedChanges&&this.getCommandStack()._aPersistedChanges.indexOf(p.getId())!==-1;};d.prototype.handleCommandExecuted=function(e){return(function(e){var p=e;this._lastPromise=this._lastPromise.catch(function(){}).then(function(){var f=this.getCommandStack().getSubCommands(p.command);var o;if(p.undo){f.forEach(function(h){if(!(h instanceof F||h instanceof A)||h.getRuntimeOnly()){return;}var i=h.getPreparedChange();var j=h.getAppComponent();if(j){if(h instanceof F){o=b.createForControl(j);var k=R.bySelector(i.getSelector(),j);o.removeFromAppliedChangesOnControl(i,j,k);}else if(h instanceof A){o=a.getAppDescriptorFlexController(j);}o.deleteChange(i,j);}});}else{var D=[];f.forEach(function(h){if(h.getRuntimeOnly()){return;}if(h instanceof F){var i=h.getAppComponent();if(i){var o=b.createForControl(i);var P=h.getPreparedChange();if(P.getState()===C.states.DELETED){P.setState(C.states.NEW);}if(!this._isPersistedChange(P)){o.addPreparedChange(h.getPreparedChange(),i);}}}else if(h instanceof A){D.push(h.createAndStoreChange());}}.bind(this));return Promise.all(D);}}.bind(this));return this._lastPromise;}.bind(this))(e);};d.prototype.needsReload=function(){this._lastPromise=this._lastPromise.catch(function(){}).then(function(){var e=this.getCommandStack().getAllExecutedCommands();return e.some(function(o){return!!o.needsReload;});}.bind(this));return this._lastPromise;};d.prototype.saveCommands=function(){this._lastPromise=this._lastPromise.catch(function(){}).then(function(){var r=g(this.getRootControl());if(!r){throw new Error("Can't save commands without root control instance!");}var f=b.createForControl(r);return f.saveAll();}.bind(this)).then(function(){var r=g(this.getRootControl());var e=c.isApplicationVariant(r)||c.isVariantByStartupParameter(r);if(!e){var f=a.getAppDescriptorFlexController(r);return f.saveAll();}}.bind(this)).then(function(){L.info("UI adaptation successfully transfered changes to layered repository");this.getCommandStack().removeAllCommands();}.bind(this));return this._lastPromise;};d.prototype._moveChangeToAppVariant=function(r,f){return S.getInstance().then(function(s){var p={reference:r};var n=c.createNamespace(p,"changes");var e=this.getCommandStack().getAllExecutedCommands();e.forEach(function(o){if(o.getPreparedChange&&!o.getRuntimeOnly()){var v=o.getPreparedChange();if(!Array.isArray(v)){v=[v];}v.forEach(function(h){if(s.isAtoEnabled()){h.setRequest("ATO_NOTIFICATION");}h.setNamespace(n);h.setComponent(r);});}});return f.saveAll(true);}.bind(this));};d.prototype._triggerUndoChanges=function(){var o=this.getCommandStack();var p=[];var e=o.getAllExecutedCommands();e.forEach(function(f){p.push(f.undo.bind(f));});p=p.reverse();return c.execPromiseQueueSequentially(p,false,true);};d.prototype._removeCommands=function(f){var o=this.getCommandStack();var e=o.getAllExecutedCommands();e.forEach(function(h){if(h instanceof F){var i=h.getPreparedChange();var j=h.getAppComponent();var k=R.bySelector(i.getSelector(),j);f.removeFromAppliedChangesOnControl(i,j,k);}});o.removeAllCommands();};d.prototype.saveAsCommands=function(r){if(!r){throw new Error("The id of the new app variant is required");}var o=g(this.getRootControl());if(!o){throw new Error("Can't save commands without root control instance!");}var e=c.getAppDescriptor(o);if(e["sap.app"].id===r){throw new Error("The id of the app variant should be different from the current app id");}var f=b.createForControl(o);var h=this.getCommandStack();return this._moveChangeToAppVariant(r,f).then(function(){h.detachCommandExecuted(this.handleCommandExecuted.bind(this));return this._triggerUndoChanges();}.bind(this)).then(function(){this._removeCommands(f);h.attachCommandExecuted(this.handleCommandExecuted.bind(this));return true;}.bind(this));};return d;},true);
