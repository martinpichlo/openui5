/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/core/BusyIndicator","sap/ui/thirdparty/jquery","sap/base/util/UriParameters"],function(F,A,B,q,U){"use strict";var a,o,r,c,C,d,D;var g=function(){return F.getAppDescriptor(r);};var t=function(j){return o.createDescriptor(j);};var T=function(s){return A.createDeletion(s);};var f=function(j){if(j){B.show();d=null;d=q.extend({},j);return o.saveAppVariantToLREP(j);}return Promise.reject();};var b=function(){return o.triggerCatalogAssignment(d);};var e=function(j){if(j){D=null;D=q.extend({},j);return o.triggerCatalogUnAssignment(D);}return Promise.reject();};var h=function(R){if(R&&R.response&&R.response.IAMId){return o.notifyKeyUserWhenTileIsReady(R.response.IAMId,d.getId());}return Promise.resolve();};var i=function(R){if(R&&R.response&&R.response.IAMId&&R.response.inProgress){A.closeOverviewDialog();return this.onGetOverview(true).then(function(){return o.notifyWhenUnpublishingIsReady(R.response.IAMId,D.getId());});}return Promise.resolve();};sap.ui.getCore().getEventBus().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(a){a.destroy();a=null;}});return{onGetOverview:function(j){var k=g();return new Promise(function(l){var m=function(){A.closeOverviewDialog();};sap.ui.require(["sap/ui/rta/appVariant/AppVariantOverviewDialog"],function(n){if(!a){a=new n({idRunningApp:k["sap.app"].id,isOverviewForKeyUser:j});}a.attachCancel(m);a.oPopup.attachOpened(function(){l(a);});a.open();});});},isOverviewExtended:function(){var u=new U(window.location.href);if(!u.get("sap-ui-xx-app-variant-overview-extended")){return false;}var m=u.get("sap-ui-xx-app-variant-overview-extended",true);if(m&&m.length){var M=m[0].toLowerCase();return M==='true';}},isManifestSupported:function(){var j=g();return A.getManifirstSupport(j["sap.app"].id).then(function(R){return R.response;}).catch(function(E){var k=A.buildErrorInfo("MSG_APP_VARIANT_FEATURE_FAILED",E);k.overviewDialog=true;return A.showRelevantDialog(k,false);});},isPlatFormEnabled:function(R,s,l){r=R;c=l;var j=g();if(j["sap.app"]&&j["sap.app"].id){if(F.getUshellContainer()&&!A.isStandAloneApp()&&s==="CUSTOMER"){var I;if(j["sap.app"].crossNavigation&&j["sap.app"].crossNavigation.inbounds){I=A.getInboundInfo(j["sap.app"].crossNavigation.inbounds);}else{I=A.getInboundInfo();}if(I){return true;}}}return false;},getAppVariantDescriptor:function(R){r=R;var j=g();if(j["sap.app"]&&j["sap.app"].id){return A.getDescriptorFromLREP(j["sap.app"].id);}return Promise.resolve(false);},onSaveAsFromRtaToolbar:function(s,j){var k;if(s){k=g();}else{k=q.extend(true,{},C);C=null;}return new Promise(function(l){var p=function(){return o.processSaveAsDialog(k,s);};var m=function(){if(j){return o.copyUnsavedChangesToLREP(d.getId(),j);}return Promise.resolve();};var n=function(R){var u=F.getUshellContainer();if(u&&j){u.setDirtyFlag(false);}return o.showSuccessMessageAndTriggerActionFlow(d,s).then(function(){return h(R).then(l);});};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(u){if(!o){o=new u({rootControl:r,commandSerializer:c});}var P=[p,t,f,m,b,n];function v(w){return w.reduce(function(x,y){return x.then(y);},Promise.resolve()).catch(function(){return Promise.resolve(false);});}v(P);});});},onSaveAsFromOverviewDialog:function(j,s){var k=false;var l=g();if(j["sap.app"].id===l["sap.app"].id){k=true;}C=q.extend(true,{},j);j=null;return this.onSaveAsFromRtaToolbar(s,k);},onDeleteFromOverviewDialog:function(s,I,j){return new Promise(function(k){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(l){if(!o){o=new l({rootControl:r,commandSerializer:c});}var m=function(){return A.triggerDeleteAppVariantFromLREP(D);};return T(s).then(e).then(i.bind(this)).then(m).then(function(){if(I&&j){A.navigateToFLPHomepage();}else{k();}}).catch(function(){return k(false);});}.bind(this));}.bind(this));}};});
