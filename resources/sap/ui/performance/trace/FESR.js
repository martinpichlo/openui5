/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/thirdparty/URI','sap/ui/Device','sap/ui/performance/trace/Passport','sap/ui/performance/trace/Interaction','sap/ui/performance/XHRInterceptor','sap/ui/performance/BeaconRequest','sap/base/util/Version'],function(U,D,P,I,X,B,V){"use strict";var f=false,b,o,R=P.getRootId(),H=window.location.host,C=D.os.name+"_"+D.os.version,a=D.browser.name+"_"+D.browser.version,c=h(),A="",s="",F,S=0,p="undetermined",d="undetermined_startup_0",e,g;function h(){var w=0;if(D.system.combi){w=1;}else if(D.system.desktop){w=2;}else if(D.system.tablet){w=4;}else if(D.system.phone){w=3;}return w;}function i(T){var w=new Date(T);return w.toISOString().replace(/[^\d]/g,'');}function j(w){var x=new U(w).host();return x&&x!==H;}function k(){if(!j(arguments[1])){this.setRequestHeader("SAP-PASSPORT",P.header(P.traceFlags(),R,P.getTransactionId(),p,d));}}function l(){if(!j(arguments[1])){if(!F){F=P.getTransactionId();}if(e&&g){this.setRequestHeader("SAP-Perf-FESRec",e);this.setRequestHeader("SAP-Perf-FESRec-opt",g);e=null;g=null;F=P.getTransactionId();}}}function m(w,x){return[q(R,32),q(F,32),q(w.navigation,16),q(w.roundtrip,16),q(x.timeToInteractive,16),q(w.completeRoundtrips,8),q(d,40),q(w.networkTime,16),q(w.requestTime,16),q(C,20),"SAP_UI5"].join(",");}function n(w,x){return[q(x.appNameShort,20,true),q(x.stepName,20,true),"",q(a,20),q(w.bytesSent,16),q(w.bytesReceived,16),"","",q(w.processing,16),w.requestCompression?"X":"","","","","",q(w.busyDuration,16),"",q(c,1),"",q(i(w.start),20),q(x.appNameLong,70,true)].join(",");}function q(w,L,x){if(!w){w=w===0?"0":"";}else if(typeof w==="number"){var y=w;w=Math.round(w).toString();if(w.length>L||y<0){w="-1";}}else{w=x?w.substr(-L,L):w.substr(0,L);}return w;}function r(w){var x=new V(w);return"@"+x.getMajor()+"."+x.getMinor()+"."+x.getPatch();}function t(w,x){e=m(w,x);g=n(w,x);}function u(w,x){var y=v.onBeforeCreated({stepName:w.trigger+"_"+w.event,appNameLong:w.stepComponent||w.component,appNameShort:w.stepComponent||w.component,timeToInteractive:w.duration},w);if(w.requests.length>0||x){t(w,y);}if(o&&e&&g){o.append("SAP-Perf-FESRec",e);o.append("SAP-Perf-FESRec-opt",g);}var z=I.getPending();if(z){if(s!=z.appVersion){s=z.appVersion;A=s?r(s):"";}}p=z?z.component+A:undefined;d=z?z.trigger+"_"+z.event+"_"+S:undefined;S++;}var v={};v.getBeaconURL=function(){return b;};v.setActive=function(w,x){o=x?B.isSupported()&&new B({url:x}):null;b=x;if(w&&!f){f=true;P.setActive(true);I.setActive(true);X.register("PASSPORT_HEADER","open",k);if(!o){X.register("FESR","open",l);}I.onInteractionFinished=u;}else if(!w&&f){f=false;b=null;I.setActive(false);X.unregister("FESR","open");if(X.isRegistered("PASSPORT_HEADER","open")){X.register("PASSPORT_HEADER","open",function(){this.setRequestHeader("SAP-PASSPORT",P.header(P.traceFlags(),R,P.getTransactionId()));});}I.onInteractionFinished=null;}};v.getActive=function(){return f;};v.onBeforeCreated=function(w,x){return{stepName:w.stepName,appNameLong:w.appNameLong,appNameShort:w.appNameShort,timeToInteractive:w.timeToInteractive};};return v;});
