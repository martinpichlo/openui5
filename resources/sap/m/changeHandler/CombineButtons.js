/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/uid","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/util/ManagedObjectModel"],function(u,J,C){"use strict";var a={};a.applyChange=function(c,o,p){if(p.modifier.targets!=="jsControlTree"){throw new Error("Combine buttons change can't be applied on XML tree");}var b=c.getDefinition();var m=p.modifier;var v=p.view;var A=p.appComponent;var s=m.bySelector(b.content.combineButtonSelectors[0],A,v);var P=m.getParent(s);var i;var d;var B;var I=sap.ui.getCore().getConfiguration().getRTL();var M;var e;var f=[];var r={parentAggregation:"",insertIndexes:[]};B=b.content.combineButtonSelectors.map(function(g){return m.bySelector(g,A,v);});d=m.getParentAggregationName(B[0],P);r.parentAggregation=d;i=m.findIndexInParentAggregation(s);M=m.createControl("sap.m.Menu",A,v,b.content.menuIdSelector);B.forEach(function(g,h){var j;var k;var S=b.content.buttonsIdForSave[h];var l=m.getProperty(g,"text");k=m.createControl("sap.m.MenuItem",A,v,S);r.insertIndexes[h]=m.findIndexInParentAggregation(g);m.attachEvent(k,"press","sap.m.changeHandler.CombineButtons.pressHandler",{selector:m.getSelector(g,A),appComponentId:A.getId()});var n="$sap.m.flexibility.CombineButtonsModel";var q=m.createControl("sap.ui.fl.util.ManagedObjectModel",A,v,Object.assign({},S,{id:S.id+'-managedObjectModel'}),{object:g,name:n});m.insertAggregation(k,"dependents",q,0,v);m.bindProperty(k,"text",n+">/text");m.bindProperty(k,"icon",n+">/icon");m.bindProperty(k,"enabled",n+">/enabled");m.bindProperty(k,"visible",n+">/visible");m.bindAggregation(k,"customData",{path:n+">/customData",template:m.createControl("sap.ui.core.CustomData",A,v,Object.assign({},S,{id:S.id+'-customData'}),{key:"{ path: '"+n+">key' }",value:"{ path: '"+n+">value' }"}),templateShareable:false},v);if(l){I?f.unshift(l):f.push(l);}S.id=S.id+"-originalButtonId";j=m.createControl("sap.ui.core.CustomData",A,v,S);m.setProperty(j,"key","originalButtonId");m.setProperty(j,"value",m.getId(g));m.removeAggregation(P,d,g);m.insertAggregation(P,"dependents",g,0,v);m.insertAggregation(g,"customData",j,0,v);m.insertAggregation(M,"items",k,h,v);});e=m.createControl("sap.m.MenuButton",A,v,b.content.menuButtonIdSelector);m.setProperty(e,"text",f.join("/"));m.insertAggregation(e,"menu",M,0,v);m.insertAggregation(P,d,e,i,v);c.setRevertData(r);return true;};a.revertChange=function(c,o,p){var m=p.modifier;var v=p.view;var r=c.getRevertData();var b=c.getDefinition();var P=r.parentAggregation;var M=m.bySelector(b.content.menuButtonIdSelector,p.appComponent,v);var d=m.getParent(M);var B=b.content.combineButtonSelectors.slice().reverse();var e;m.removeAggregation(d,P,M);m.destroy(M);for(var i=0,l=B.length;i<l;i++){e=m.bySelector(B[i],p.appComponent,v);m.getAggregation(e,"customData").some(function(f){if(m.getProperty(f,"key")==="originalButtonId"){m.destroy(f);return true;}});m.insertAggregation(d,P,e,r.insertIndexes[l-i-1],v);}c.resetRevertData();return true;};a.completeChangeContent=function(c,s,p){var m=p.modifier;var A=p.appComponent;var o=c.getDefinition();var b=s.combineElementIds;if(b&&b.length>1){c.addDependentControl(b,"combinedButtons",p);o.content.combineButtonSelectors=b.map(function(d){return m.getSelector(d,A);});o.content.menuButtonIdSelector=m.getSelector(A.createId(u()),A);o.content.menuIdSelector=m.getSelector(A.createId(u()),A);o.content.buttonsIdForSave=b.map(function(){return m.getSelector(A.createId(u()),A);});}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineElementIds attribute required");}};a.pressHandler=function(e,p){var b=J.bySelector(p.selector,C.get(p.appComponentId));b.firePress();};return a;},true);
